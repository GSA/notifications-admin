{% from "components/page-header.html" import page_header %}
{% from "components/big-number.html" import big_number %}
{% from "components/live-search.html" import live_search %}
{% from "components/pill.html" import pill %}
{% from "components/table.html" import list_table, field, row_heading %}
{% extends "withnav_template.html" %}

{% block org_page_title %}
  Organization Dashboard
{% endblock %}

{% block maincolumn_content %}

  {{ page_header('Organization Dashboard', size='large') }}

  <h2 class="font-heading-md">Overall {{ selected_year }} Total Message Usage</h2>
  <p class="usa-body">Combined totals across all services in {{ current_org.name }}</p>

  <div class="margin-bottom-3">
    <nav aria-label="Financial year selector">
      <ul class="usa-list usa-list--unstyled display-flex flex-gap-05 padding-0 margin-0">
        {% for label, year, link, display_text in years %}
          <li>
            {% if selected_year == year %}
              <button class="usa-button" disabled aria-current="page">
                {{ display_text }}
              </button>
            {% else %}
              <a href="{{ link }}" class="usa-button" role="button">
                {{ display_text }}
              </a>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </nav>
  </div>

  <div id="totalMessageChartContainer" data-messages-sent="{{ messages_sent|default(0) }}" data-messages-remaining="{{ messages_remaining|default(0) }}">
    <div class="grid-row flex-align-center">
      <h2 id="chartTitle" class="margin-right-1">Total messages</h2>
      <button
        type="button"
        class="usa-tooltip usa-tooltip__information margin-right-0"
        data-position="top"
        title="Total messages track the sum of messages across all services in this organization: pending, failed, or delivered"
      >
        <span class="usa-sr-only">More information</span>
        i
      </button>
    </div>
    <svg id="totalMessageChart"></svg>
    <div id="message"></div>
  </div>
  <div id="totalMessageTable" class="margin-bottom-3"></div>

  <div class="grid-row margin-bottom-3">
    <div class="grid-col-6">
      <h2 class="font-heading-md">Emails</h2>
      <div class="keyline-block">
        {{ big_number(
          total_emails_sent,
          label='sent',
          smaller=True
        ) }}
      </div>
    </div>
    <div class="grid-col-6">
      <h2 class="font-heading-md">Text messages</h2>
      <div class="keyline-block">
        {{ big_number(
          total_sms_cost,
          'spent',
          currency="$",
          smaller=True
        ) }}
      </div>
    </div>
  </div>

  {% if search_form %}
    <div>
      {{ live_search(
        target_selector='.organization-service',
        show=True,
        form=search_form,
        label='Search by service'
      ) }}
    </div>
  {% endif %}

  <h2 class="font-heading-md {% if search_form %}visually-hidden{% endif %}">By service</h2>

  {% for service in services %}
    <div class="keyline-block organization-service">
      <h3 class="live-search-relevant">
        <a href="{{ url_for('main.usage', service_id=service.service_id) }}" class="usa-link browse-list-link">{{ service.service_name  }}</a>
      </h3>
      <div class="grid-row">
        <div class="grid-col-6">
          {{ big_number(
            service.emails_sent,
            label=service.emails_sent|message_count_label('email'),
            smallest=True
          ) }}
        </div>
        <div class="grid-col-6">
          {% if service.sms_cost %}
            {{ big_number(
              service.sms_cost,
              'spent on text messages',
              currency="$",
              smallest=True
            ) }}
          {% else %}
            {{ big_number(
              service.sms_billable_units,
              'free {}'.format(service.sms_billable_units|message_count_label('sms')),
              smallest=True
            ) }}
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
  <div class="keyline-block"></div>
  {% if not services %}
    <p class="usa-body usa-hint">
      {{ current_org.name }} has no live services on Notify.gov
    </p>
    <div class="keyline-block"></div>
  {% else %}
    <div class="js-stick-at-bottom-when-scrolling">
      <p>
        <a href="{{ download_link }}" download="download" class="usa-link">Download this report (<abbr title="Comma separated values">CSV</abbr>)</a>
      </p>
    </div>
  {% endif %}

{% endblock %}
